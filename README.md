# ABoVE_DA_LAIandBiomass
This repo includes scripts and files used to conduct model experiments described in the manuscript of the ABoVE data assimilation work. It also includes matlab scripts used to plot the figures and do the statistical analysis in the manuscript. The manuscript can be found here: https://docs.google.com/document/d/1R4NtlvAd91JJiQjqP6nnrKpwn3-B08l3t7bCRuDPPb0

1. FigureScripts:
     1) It includes matlab scripts to plot the figures and do the statistical analysis in the manuscript. Figure1-5.m correspond to figures in the main body of the manuscript, and FigureS1-S6.m correspond to figures in the supplement of the manuscript. Note Figure4 in the main body and FigureS3 in the supplement of the manuscript are generated by ILAMB (The International Land Model Benchmarking) not matlab scripts. The ILAMB repo used to do the ILAMB assessment (of which the result is shown in Figure4) in the manuscript is https://github.com/XueliHuo/ILAMB. It was forked from the https://github.com/rubisco-sfa/ILAMB and modified for this regional application.
     2) Data used in the matlab scripts are stored on CyVerse and can be accessed from https://de.cyverse.org/data/ds/iplant/home/huoxl90/ABoVE_DA_Data/ABoVE_DA_LAIandBiomass_Data?type=folder&resourceId=5915919c-f830-11ed-a80f-90e2ba675364. In addition to the data used in the matlab scripts, this folder also includes two nc files: 
             1) LAIaSTD_stdfixed_025d_AddFillValue_2011-2020.nc is the observation of LAI regridded from the 500-m MODIS LAI. The obs_converter uses this nc file to generate the obs sequence files of LAI. Also, the obslaimonth.mat is created using the data in this nc file.
             2) Wang_BiomassandSTD_convert_to_carbon_2011t2014Sep.nc is the observation of aboveground biomass regridded from the 30-m machine learning product developed for the ABoVE core region. Same as LAI, it is used by the obs_converter to generate observation sequence files of aboveground biomass and the obstransbiomassinmodelarea.mat is the mat form of the data in this nc file.
2. Modelruns:
     1) This folder includes two 40-ensemble model runs: data assimilation run (DA) and free run (Free). It also includes three single-member runs in the SinglerunGPP for the comparison of GPP improvement. The CLM version used is a tag in the CTSM git repo https://github.com/ESCOMP/CTSM. After checking out the tag branch_tags/PPE.n03_ctsm5.1.dev021 and creating a new branch called "PPE.n01_ctsm5.1.dev012" based on that tag, the critical negative C and N values were modified in the bld/namelist_files/namelist_defaults_ctsm.xml to avoid the model run from aborting, which was caused by the negative values of C and N being smaller than the default critical negative values. The change was committed and pushed to the git repo https://github.com/XueliHuo/CTSM/commits/PPE.n01_ctsm5.1.dev012. The reason why we used the tag branch_tags/PPE.n03_ctsm5.1.dev021 back then was it was the only version that included the modifications Leah Birch et al (2021) made in CLM that yielded a better simulation of GPP in the Arctic-boreal region. However, it turns out these modifications in Leah Birch et al (2021) were not implemented in any of the model runs because the corresponding options in the user_nl_clm were not turned on. Unfortunately, this was found at a late stage of this work after all the model experiments were finished.
     2) Both ensemble runs DA and Free run from 2011-01-01 to 2020-01-01. The shell scripts DART_params.csh, PPE.n01_ctsm5.1.dev_arctic_assimtest, CESM2_0_DART_config, assimilate.csh, and the input.nml are from DART and some of them were renamed as they are currently labeled. Modifications were made to these files for this specific application. The check*date.txt and user_nl_clm_temp_cycleassim are used in the assimilate.csh for different purpos for different purposes. The check*date.txt files are used for automatically removing some restart files to save space while the model is running, and the user_nl_clm_temp_cycleassim is used to set the correct user_nl_clm* files which vary with different stop options modified by the assimilate.csh while the model is running. Assimilation was deactivated in the Free run by assigning a null value to the assimilate_these_obs_types in the input.nml, and the implementation of assimilate.csh in the Free run is to enable the output of data in all four stages in an data assimilation cycle which will be used by the diagnosis tools within DART for comparison with the DA run.In the DA run, assimilation of LAI and aboveground biomass is activated by assigning valid values to the assimilate_these_obs_types in the input.nml. Note there are three different files of input.nml, i.e., input.nml.damp4, input.nml.damp9 and input.nml.updateall to select from depending on what time it is during the simuluation period. The aboveground biomass observation is annual which needs to be assigned a specific date due to the fact the assimilation only happens on certain dates. The aboveground biomass ends in 2014 and it overlaps with LAI observation from 2011 to 2014, which means there is no aboveground biomass from 2015. Additionally, the spatial coverage of LAI observation in the ABoVE region varies with time in a year. Hence, different files of input.nml were used to accommodate such characteristics of these observations. The assimilate.csh will automatically select the right one from these three files for the time and copyies it into the input.nml which the filter needs. The DART code used to carry out the two ensemble runs can be found here: https://github.com/XueliHuo/DART_CLM/tree/arctic_assim_prepare. It is a branch of the DART_CLM git repo, and this repo was forked from https://github.com/NCAR/DART_CLM.
3. SinglerunGPP:
     1) The three single-member model runs are forcing with the same forcing data which is the first member in the CAM6 ensemble. They all ran for one year which is 2015. The Initialization started from the initailization achieved by DA. The Parameterization started from the initailization in the free run but with the new parameterization. The ParameterizationInitilization started from the initailization achieved by DA and ran with the new parameterization. The new parameterization is coded in the SourceMods/src.clm/PhotosynthesisMod.F90. See details of the difference between them in the manuscript https://docs.google.com/document/d/1R4NtlvAd91JJiQjqP6nnrKpwn3-B08l3t7bCRuDPPb0. All of the three runs share the same script quantumyield_curvature_correction to create and build its own case with different params files quantum_params.csh.
4. Supportingruns:
     1) The PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_freerun_reruntorestorerestartfiles_e40 in the RegenerateRestartinFreerunPurged folder was conducted to get the initialization file for the Parameterization run at the beginning of the year 2015 since all the restart files generated in the Free run were purged automatically on Cheyenne. This experiment has the exactly same settings in the scripts as the Free run. The only difference is it ran from 2011 to 2014 since the computational resource became limited then. The DART_params.csh is put under the directory because it is the only file which differs from the DART_params.csh in the Free run and the differences are in CASE name and project number. All the other scripts needed are the same as the Free run.
     2) The Spinup folder includes three successive spinup model runs. Both the PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_spinup and PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_reseed are single-member model runs in which CLM was forced by the forcing data that is the first member in the CAM6 ensemble. The PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_generatespread_e80 is an 80-ensemble spinup model run. The PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_spinup runs for 120 cycles (equals to 1080 years) using the first member CAM6 reanalysis forcing data, and it started from the initialization condition provided by the file f.e21.FHIST_BGC.f09_025.CAM6assim.011.clm2_0001.r.2011-01-03-00000.nc. This file is a restart file generated in the CAM6 experiment (Raeder et al, 2021; ds345.0). Unfortunately, this file was purged automatically on Cheyenne. The restart file generated at the end of the 120 cycles was used as the initialization for the reseed experiment. The reseed experiment was conducted to allow the vegetation to regrow in the Nelchina Public Use Area in South Alaska, which eliminated the artificial-like "rectangle box" inherited from the 1-degree initialization where the value of TLAI was 0. If without the reseed experiment, the artificial-like "rectangle box" will persist no matter how long the spinup is. The reseed went for 12 cycles (108 years). Then the PPE.n01_ctsm5.1.dev012_0.25x0.25_arctic_cam6for_generatespread_e80 was conducted to generate the ensemble spread. It started from the initialization provided by the restart file generated at the end of the 12-cycle reseed experiment, and were driven by the 80-ensemble CAM6 for 4 cycles (36 years) to provide the initialization for the DA and the Free run.
     3) Each folder within the Spinup includes the params script (DART_params*.csh) and the  PPE.n01_ctsm5.1.dev_regional_* script to creat and build its own case. The changestopdate*.csh was executed to change the stop date and the initialization file for each spinup cycle. The user_nl_clm_temp file was used in the changestopdate*.csh.

This repo is fully described in the README, and hope the paragraphs here are helpful to you. If you have any question, please don't hesitate to reach out to me: huoxl90@arizona.edu or huoxl90@gmail.com



